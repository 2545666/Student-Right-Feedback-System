name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: éƒ¨ç½²åº”ç”¨
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ”¨ æ„å»ºå‰ç«¯
        run: |
          cd frontend
          npm ci
          npm run build
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/buct-feedback-system
            
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main
            
            echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
            cd backend
            npm ci --production
            
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            pm2 restart feedback-backend || pm2 start server.js --name feedback-backend
            
            echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
            cd ../frontend
            npm ci
            npm run build
            
            echo "ğŸ“‚ éƒ¨ç½²å‰ç«¯æ–‡ä»¶..."
            sudo cp -r dist/* /var/www/html/
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      
      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
